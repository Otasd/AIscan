#!/bin/bash

# AIScan Private Edition v2.1 - Local AI with Real Vulnerability Intelligence
# Privacy-First: All AI processing stays local, only CVE queries go to NVD

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

# Configuration
LOCAL_AI_MODEL="huihui_ai/qwen3-abliterated:8b"
NVD_API_KEY="3D60BBF1-DAC2-F011-8364-129478FCB64D"
TEMP_DIR="/tmp/aiscan_$$"
mkdir -p "$TEMP_DIR"

# Load config
CONFIG_FILE="$HOME/.aiscan.conf"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

trap "rm -rf $TEMP_DIR" EXIT

show_banner() {
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                                            â•‘${NC}"
    echo -e "${RED}â•‘   ğŸ”’ ${BOLD}AIScan PRIVATE EDITION${NC}${RED} ğŸ”’         â•‘${NC}"
    echo -e "${RED}â•‘   Local AI + Real CVE Intelligence        â•‘${NC}"
    echo -e "${RED}â•‘   ğŸ›¡ï¸  100% Client Data Privacy  ğŸ›¡ï¸         â•‘${NC}"
    echo -e "${RED}â•‘                                            â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

usage() {
    echo -e "${YELLOW}Usage:${NC} $0 <target> [options]"
    echo ""
    echo -e "${YELLOW}Arguments:${NC}"
    echo "  target              Domain or IP to scan"
    echo "  -l, --list FILE     Scan multiple targets from file (one per line)"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  -m, --model MODEL   Local AI model (default: llama3.2:latest)"
    echo "  -q, --quick         Quick scan (faster, less thorough)"
    echo "  -f, --full          Full aggressive scan (all tools, deep analysis)"
    echo "  --no-ai             Skip AI analysis (tools only mode)"
    echo "  --export-for-ai     Export scan results for external AI analysis"
    echo "  --import-ai FILE    Import AI analysis from external source"
    echo "  --no-vulnintel      Skip CVE database lookup"
    echo "  -h, --help          Show this help"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  $0 target.com                          # Standard scan"
    echo "  $0 target.com --full                   # Full aggressive scan"
    echo "  $0 target.com --no-ai                  # Scan without AI"
    echo "  $0 target.com --export-for-ai          # Export for external AI"
    echo "  $0 -l targets.txt                      # Scan multiple targets"
    echo "  $0 target.com --import-ai analysis.txt # Import external AI analysis"
    echo ""
    exit 1
}

# Parse arguments
TARGET=""
TARGET_LIST=""
QUICK_SCAN=false
FULL_SCAN=false
SKIP_VULNINTEL=false
NO_AI=false
EXPORT_FOR_AI=false
IMPORT_AI=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--model)
            LOCAL_AI_MODEL="$2"
            shift 2
            ;;
        -l|--list)
            TARGET_LIST="$2"
            shift 2
            ;;
        -q|--quick)
            QUICK_SCAN=true
            shift
            ;;
        -f|--full)
            FULL_SCAN=true
            shift
            ;;
        --no-ai|--noai)
            NO_AI=true
            shift
            ;;
        --export-for-ai)
            EXPORT_FOR_AI=true
            NO_AI=true
            shift
            ;;
        --import-ai)
            IMPORT_AI="$2"
            shift 2
            ;;
        --no-vulnintel)
            SKIP_VULNINTEL=true
            shift
            ;;
        -h|--help)
            show_banner
            usage
            ;;
        *)
            if [[ -z "$TARGET" ]]; then
                TARGET="$1"
            else
                echo -e "${RED}Error: Unknown argument: $1${NC}"
                usage
            fi
            shift
            ;;
    esac
done

show_banner

# Handle multiple targets
if [[ -n "$TARGET_LIST" ]]; then
    if [[ ! -f "$TARGET_LIST" ]]; then
        echo -e "${RED}Error: Target list file not found: $TARGET_LIST${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}ğŸ“‹ Scanning multiple targets from: $TARGET_LIST${NC}"
    echo ""
    
    mapfile -t TARGETS < "$TARGET_LIST"
    TOTAL_TARGETS=${#TARGETS[@]}
    CURRENT_TARGET=0
    
    for target in "${TARGETS[@]}"; do
        # Skip empty lines and comments
        [[ -z "$target" || "$target" =~ ^# ]] && continue
        
        CURRENT_TARGET=$((CURRENT_TARGET + 1))
        echo -e "${BOLD}${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}${CYAN}Target [$CURRENT_TARGET/$TOTAL_TARGETS]: $target${NC}"
        echo -e "${BOLD}${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        
        # Recursive call for each target
        $0 "$target" $([ "$QUICK_SCAN" = true ] && echo "--quick") \
                     $([ "$FULL_SCAN" = true ] && echo "--full") \
                     $([ "$NO_AI" = true ] && echo "--no-ai") \
                     $([ "$SKIP_VULNINTEL" = true ] && echo "--no-vulnintel") \
                     -m "$LOCAL_AI_MODEL"
        
        echo ""
        echo -e "${GREEN}âœ“ Completed $target ($CURRENT_TARGET/$TOTAL_TARGETS)${NC}"
        echo ""
        
        # Delay between targets to avoid rate limiting
        if [ $CURRENT_TARGET -lt $TOTAL_TARGETS ]; then
            echo -e "${YELLOW}â³ Waiting 30 seconds before next target...${NC}"
            sleep 30
        fi
    done
    
    echo ""
    echo -e "${BOLD}${GREEN}âœ… All targets scanned! ($TOTAL_TARGETS total)${NC}"
    exit 0
fi

# Single target validation
if [[ -z "$TARGET" ]]; then
    echo -e "${RED}Error: No target specified${NC}"
    usage
fi

echo -e "${BOLD}${RED}ğŸ¯ Target: ${NC}${TARGET}"
echo -e "${RED}ğŸ¤– Local AI Model: ${NC}$([ "$NO_AI" = true ] && echo "${YELLOW}DISABLED${NC}" || echo "$LOCAL_AI_MODEL")"
echo -e "${RED}ğŸ”’ Privacy Mode: ${NC}${GREEN}ENABLED${NC} ${CYAN}(All data stays local)${NC}"
echo -e "${RED}ğŸ“¡ CVE Database: ${NC}$([ "$SKIP_VULNINTEL" = true ] && echo "${YELLOW}DISABLED${NC}" || echo "${GREEN}NVD.gov${NC}")"
echo -e "${RED}âš¡ Scan Mode: ${NC}$([ "$QUICK_SCAN" = true ] && echo "Quick" || ([ "$FULL_SCAN" = true ] && echo "Full Aggressive" || echo "Standard"))"
echo ""
echo -e "${YELLOW}âš ï¸  AUTHORIZED TESTING ONLY${NC}"
echo ""
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

START_TIME=$(date +%s)
ALL_RESULTS=""
SCAN_COUNT=0
TOTAL_SCANS=12

run_scan() {
    local name=$1
    local command=$2
    local output_file=$3
    
    SCAN_COUNT=$((SCAN_COUNT + 1))
    echo -e "${MAGENTA}[$SCAN_COUNT/$TOTAL_SCANS]${NC} ${BOLD}$name${NC}"
    
    eval "$command" > "$output_file" 2>&1 &
    local cmd_pid=$!
    
    local spin='-\|/'
    local i=0
    local elapsed=0
    
    while kill -0 $cmd_pid 2>/dev/null; do
        printf "\r${BLUE}[${spin:i++%${#spin}:1}]${NC} Running... ${elapsed}s "
        sleep 0.5
        elapsed=$((elapsed + 1))
    done
    
    wait $cmd_pid 2>/dev/null
    local exit_code=$?
    
    if [ $exit_code -eq 0 ] && [ -s "$output_file" ]; then
        printf "\r${GREEN}âœ“ Complete (${elapsed}s)                    ${NC}\n"
        return 0
    else
        printf "\r${YELLOW}âš  Failed or no results (${elapsed}s)        ${NC}\n"
        return 1
    fi
}

# ============================================================================
# SCANNING PHASE
# ============================================================================

echo -e "${BOLD}${CYAN}ğŸ” PHASE 1: RECONNAISSANCE & ENUMERATION${NC}"
echo ""

# 1. Nmap
NMAP_OUT="$TEMP_DIR/nmap.txt"
if [ "$QUICK_SCAN" = true ]; then
    run_scan "Nmap: Quick scan (top 100 ports)" \
             "nmap -T4 -F -sV --version-intensity 5 '$TARGET'" \
             "$NMAP_OUT"
elif [ "$FULL_SCAN" = true ]; then
    run_scan "Nmap: Common ports scan (top 1000) + version detection" \
             "nmap -T4 --top-ports 1000 -sV --version-intensity 9 -sC --script='banner,version,vuln' '$TARGET'" \
             "$NMAP_OUT"
else
    run_scan "Nmap: Standard scan (top 1000 ports)" \
             "nmap -T4 --top-ports 1000 -sV --version-intensity 7 -sC '$TARGET'" \
             "$NMAP_OUT"
fi
[ $? -eq 0 ] && ALL_RESULTS+="=== NMAP PORT & VERSION SCAN ===\n$(cat $NMAP_OUT)\n\n"
echo ""

# 2. WhatWeb
if command -v whatweb &> /dev/null; then
    WHATWEB_OUT="$TEMP_DIR/whatweb.txt"
    run_scan "WhatWeb: Technology fingerprinting" \
             "whatweb -v -a 3 'http://$TARGET' 'https://$TARGET' 2>/dev/null" \
             "$WHATWEB_OUT"
    [ $? -eq 0 ] && ALL_RESULTS+="=== WHATWEB TECHNOLOGY DETECTION ===\n$(cat $WHATWEB_OUT)\n\n"
    echo ""
fi

# 3. Wafw00f
if command -v wafw00f &> /dev/null; then
    WAF_OUT="$TEMP_DIR/waf.txt"
    run_scan "Wafw00f: WAF/CDN detection" \
             "wafw00f 'https://$TARGET' -a 2>/dev/null" \
             "$WAF_OUT"
    [ $? -eq 0 ] && ALL_RESULTS+="=== WAF/CDN DETECTION ===\n$(cat $WAF_OUT)\n\n"
    echo ""
fi

# 4. DNS enumeration
DNS_OUT="$TEMP_DIR/dns.txt"
run_scan "DNS: Information gathering" \
         "host '$TARGET'; dig '$TARGET' ANY +noall +answer; nslookup '$TARGET' 2>/dev/null" \
         "$DNS_OUT"
[ -s "$DNS_OUT" ] && ALL_RESULTS+="=== DNS INFORMATION ===\n$(cat $DNS_OUT)\n\n"
echo ""

# 5. HTTP Headers
HEADERS_OUT="$TEMP_DIR/headers.txt"
run_scan "HTTP: Security headers analysis" \
         "curl -sI 'http://$TARGET' 2>/dev/null; echo '---HTTPS---'; curl -sI 'https://$TARGET' 2>/dev/null" \
         "$HEADERS_OUT"
[ -s "$HEADERS_OUT" ] && ALL_RESULTS+="=== HTTP SECURITY HEADERS ===\n$(cat $HEADERS_OUT)\n\n"
echo ""

echo -e "${BOLD}${CYAN}ğŸ¯ PHASE 2: VULNERABILITY SCANNING${NC}"
echo ""

# 6. Nikto
if command -v nikto &> /dev/null && [ "$QUICK_SCAN" = false ]; then
    NIKTO_OUT="$TEMP_DIR/nikto.txt"
    run_scan "Nikto: Web vulnerability scanner" \
             "timeout 300 nikto -h 'http://$TARGET' -Tuning x 2>/dev/null" \
             "$NIKTO_OUT"
    [ -s "$NIKTO_OUT" ] && ALL_RESULTS+="=== NIKTO WEB VULNERABILITIES ===\n$(cat $NIKTO_OUT)\n\n"
    echo ""
fi

# 7. Nuclei
if command -v nuclei &> /dev/null; then
    NUCLEI_OUT="$TEMP_DIR/nuclei.txt"
    if [ "$QUICK_SCAN" = true ]; then
        run_scan "Nuclei: Critical CVE scanning" \
                 "timeout 180 nuclei -u 'http://$TARGET' -t ~/nuclei-templates/cves/ -severity critical -silent 2>/dev/null" \
                 "$NUCLEI_OUT"
    else
        run_scan "Nuclei: Multi-template vulnerability scanning" \
                 "timeout 600 nuclei -u 'http://$TARGET' -t ~/nuclei-templates/ -severity critical,high,medium -silent 2>/dev/null" \
                 "$NUCLEI_OUT"
    fi
    [ -s "$NUCLEI_OUT" ] && ALL_RESULTS+="=== NUCLEI VULNERABILITY SCAN ===\n$(cat $NUCLEI_OUT)\n\n"
    echo ""
fi

# 8. SSL/TLS testing
if command -v testssl.sh &> /dev/null; then
    TESTSSL_OUT="$TEMP_DIR/testssl.txt"
    run_scan "TestSSL: SSL/TLS security analysis" \
             "timeout 120 testssl.sh --fast --severity HIGH '$TARGET' 2>/dev/null" \
             "$TESTSSL_OUT"
    [ -s "$TESTSSL_OUT" ] && ALL_RESULTS+="=== SSL/TLS SECURITY ANALYSIS ===\n$(cat $TESTSSL_OUT)\n\n"
    echo ""
else
    SSL_OUT="$TEMP_DIR/ssl_basic.txt"
    run_scan "OpenSSL: Basic certificate check" \
             "echo | timeout 10 openssl s_client -connect '$TARGET:443' -servername '$TARGET' 2>/dev/null | openssl x509 -noout -text 2>/dev/null" \
             "$SSL_OUT"
    [ -s "$SSL_OUT" ] && ALL_RESULTS+="=== SSL CERTIFICATE INFO ===\n$(cat $SSL_OUT)\n\n"
    echo ""
fi

# 9. SQL Injection testing (Full scan only)
if command -v sqlmap &> /dev/null && [ "$FULL_SCAN" = true ]; then
    SQLMAP_OUT="$TEMP_DIR/sqlmap.txt"
    run_scan "SQLMap: SQL injection testing" \
             "timeout 300 sqlmap -u 'http://$TARGET' --batch --crawl=2 --level=2 --risk=2 --threads=5 --random-agent 2>/dev/null" \
             "$SQLMAP_OUT"
    [ -s "$SQLMAP_OUT" ] && ALL_RESULTS+="=== SQL INJECTION TESTING ===\n$(cat $SQLMAP_OUT)\n\n"
    echo ""
fi

# 10. Robots.txt and sitemap
ROBOTS_OUT="$TEMP_DIR/robots.txt"
run_scan "Robots.txt & Sitemap analysis" \
         "curl -s 'http://$TARGET/robots.txt' 2>/dev/null; echo '---'; curl -s 'http://$TARGET/sitemap.xml' 2>/dev/null | head -50" \
         "$ROBOTS_OUT"
[ -s "$ROBOTS_OUT" ] && ALL_RESULTS+="=== ROBOTS.TXT & SITEMAP ===\n$(cat $ROBOTS_OUT)\n\n"
echo ""

END_TIME=$(date +%s)
TOTAL_TIME=$((END_TIME - START_TIME))
MINUTES=$((TOTAL_TIME / 60))
SECONDS=$((TOTAL_TIME % 60))

echo ""
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}${GREEN}âœ“ Scanning Complete! (${MINUTES}m ${SECONDS}s)${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ============================================================================
# CVE INTELLIGENCE PHASE
# ============================================================================

if [ "$SKIP_VULNINTEL" = false ]; then
    echo -e "${BOLD}${CYAN}ğŸ›¡ï¸  PHASE 3: CVE INTELLIGENCE GATHERING${NC}"
    echo ""
    
    cat > "$TEMP_DIR/vulnintel_enhanced.py" << 'EOFPYTHON'
#!/usr/bin/env python3
import re, requests, json, sys
from typing import List, Dict, Set

NVD_API_KEY = "3D60BBF1-DAC2-F011-8364-129478FCB64D"

def parse_all_services(scan_text: str) -> List[Dict]:
    """Extract services from ALL scan results"""
    services = []
    seen_services = set()
    
    # Parse Nmap output
    nmap_pattern = r'(\d+)/(tcp|udp)\s+open\s+(\S+)\s*(.*?)(?:\n|$)'
    for match in re.finditer(nmap_pattern, scan_text, re.MULTILINE):
        port, proto, service, version_info = match.groups()
        product, version = extract_product_version(version_info)
        
        if product and version:
            key = f"{product}_{version}"
            if key not in seen_services:
                services.append({
                    'port': port, 'protocol': proto, 'service': service,
                    'product': product, 'version': version, 'source': 'nmap'
                })
                seen_services.add(key)
    
    # Parse WhatWeb output
    whatweb_patterns = {
        r'Apache\[([^\]]+)\]': 'Apache',
        r'nginx\[([^\]]+)\]': 'nginx',
        r'PHP\[([^\]]+)\]': 'PHP',
        r'MySQL\[([^\]]+)\]': 'MySQL',
        r'WordPress\[([^\]]+)\]': 'WordPress',
        r'jQuery\[([^\]]+)\]': 'jQuery',
        r'OpenSSL\[([^\]]+)\]': 'OpenSSL',
        r'Drupal\[([^\]]+)\]': 'Drupal',
        r'Joomla\[([^\]]+)\]': 'Joomla',
    }
    
    for pattern, product in whatweb_patterns.items():
        match = re.search(pattern, scan_text)
        if match:
            version = match.group(1)
            key = f"{product}_{version}"
            if key not in seen_services:
                services.append({
                    'port': 'N/A', 'protocol': 'http', 'service': 'web',
                    'product': product, 'version': version, 'source': 'whatweb'
                })
                seen_services.add(key)
    
    return services

def extract_product_version(version_info: str) -> tuple:
    """Extract product and version from version string"""
    if not version_info:
        return "", ""
    
    parts = version_info.split()
    if len(parts) < 1:
        return "", ""
    
    product = parts[0]
    version = ""
    
    for part in parts[1:]:
        if re.match(r'[\d.]+', part):
            version = part.split('(')[0]
            break
    
    return product, version

def query_nvd(product: str, version: str) -> List[Dict]:
    """Query NVD for CVEs"""
    try:
        url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        headers = {'apiKey': NVD_API_KEY} if NVD_API_KEY else {}
        params = {'keywordSearch': f"{product} {version}", 'resultsPerPage': 10}
        
        response = requests.get(url, params=params, headers=headers, timeout=15)
        
        if response.status_code == 200:
            data = response.json()
            vulns = []
            
            for item in data.get('vulnerabilities', []):
                cve = item.get('cve', {})
                cve_id = cve.get('id', 'N/A')
                
                metrics = cve.get('metrics', {})
                cvss_score = 0.0
                severity = "UNKNOWN"
                
                if 'cvssMetricV31' in metrics and metrics['cvssMetricV31']:
                    cvss_data = metrics['cvssMetricV31'][0]['cvssData']
                    cvss_score = cvss_data.get('baseScore', 0.0)
                    severity = cvss_data.get('baseSeverity', 'UNKNOWN')
                elif 'cvssMetricV2' in metrics and metrics['cvssMetricV2']:
                    cvss_score = metrics['cvssMetricV2'][0]['cvssData'].get('baseScore', 0.0)
                
                desc = cve.get('descriptions', [{}])[0].get('value', 'No description')[:200]
                
                vulns.append({
                    'cve_id': cve_id,
                    'cvss_score': cvss_score,
                    'severity': severity,
                    'description': desc
                })
            
            return vulns
    except Exception as e:
        print(f"NVD query error for {product} {version}: {e}", file=sys.stderr)
    
    return []

# Main execution
scan_data = sys.stdin.read()
services = parse_all_services(scan_data)

print(f"Found {len(services)} services with version info\n")

critical_found = False
for svc in services:
    print(f"ğŸ” {svc['product']} {svc['version']} (detected by {svc['source']})")
    vulns = query_nvd(svc['product'], svc['version'])
    
    if vulns:
        print(f"   âš ï¸  Found {len(vulns)} potential CVEs:")
        for v in sorted(vulns, key=lambda x: x['cvss_score'], reverse=True)[:5]:
            if v['cvss_score'] >= 9.0:
                severity_symbol = "ğŸ”´ CRITICAL"
                critical_found = True
            elif v['cvss_score'] >= 7.0:
                severity_symbol = "ğŸŸ  HIGH"
            elif v['cvss_score'] >= 4.0:
                severity_symbol = "ğŸŸ¡ MEDIUM"
            else:
                severity_symbol = "ğŸŸ¢ LOW"
            
            print(f"   {severity_symbol} {v['cve_id']} - CVSS {v['cvss_score']} ({v['severity']})")
            print(f"      {v['description']}")
    else:
        print("   âœ“ No known CVEs found in NVD")
    print()

if critical_found:
    print("\n" + "="*70)
    print("âš ï¸  CRITICAL VULNERABILITIES DETECTED - IMMEDIATE ACTION REQUIRED âš ï¸")
    print("="*70 + "\n")
EOFPYTHON

    chmod +x "$TEMP_DIR/vulnintel_enhanced.py"
    
    echo -e "${CYAN}ğŸ“¡ Querying NVD database for CVEs...${NC}"
    echo ""
    
    VULNINTEL_OUT="$TEMP_DIR/vulnintel_results.txt"
    echo -e "$ALL_RESULTS" | python3 "$TEMP_DIR/vulnintel_enhanced.py" 2>&1 | tee "$VULNINTEL_OUT"
    
    if [ -s "$VULNINTEL_OUT" ]; then
        ALL_RESULTS+="\n=== CVE INTELLIGENCE (NVD Database) ===\n$(cat $VULNINTEL_OUT)\n\n"
    fi
    
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
fi

# ============================================================================
# EXPORT FOR EXTERNAL AI
# ============================================================================

if [ "$EXPORT_FOR_AI" = true ]; then
    EXPORT_FILE="$HOME/aiscan_export_${TARGET}_$(date +%Y%m%d_%H%M%S).txt"
    
    cat > "$EXPORT_FILE" << EOFEXPORT
==============================================
AISCAN EXPORT FOR EXTERNAL AI ANALYSIS
==============================================

Target: $TARGET
Scan Date: $(date)
Scan Duration: ${MINUTES}m ${SECONDS}s
Scan Mode: $([ "$QUICK_SCAN" = true ] && echo "Quick" || ([ "$FULL_SCAN" = true ] && echo "Full" || echo "Standard"))

==============================================
INSTRUCTIONS FOR AI ANALYSIS:
==============================================

Analyze the following security scan results and provide:

1. **CRITICAL VULNERABILITIES** (CVSS â‰¥9.0):
   - CVE ID and detailed explanation
   - Step-by-step exploitation scenario
   - Real-world attack impact
   - Immediate remediation steps

2. **HIGH PRIORITY ISSUES** (CVSS 7.0-8.9):
   - Vulnerability description
   - Exploitation difficulty
   - Recommended fixes

3. **SECURITY CONFIGURATION ANALYSIS**:
   - Missing security headers
   - SSL/TLS weaknesses
   - Service misconfigurations

4. **REMEDIATION ROADMAP**:
   - Immediate actions (24 hours)
   - Short-term fixes (1 week)
   - Long-term improvements (1 month)

==============================================
SCAN RESULTS:
==============================================

$(echo -e "$ALL_RESULTS")

==============================================
END OF EXPORT
==============================================
EOFEXPORT

    echo ""
    echo -e "${GREEN}âœ… Scan results exported for external AI analysis:${NC}"
    echo -e "${CYAN}   $EXPORT_FILE${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo -e "1. Copy the file content"
    echo -e "2. Paste into ChatGPT/Claude/Gemini"
    echo -e "3. Save the AI response to a file"
    echo -e "4. Import back: $0 $TARGET --import-ai <ai_response.txt>"
    echo ""
    exit 0
fi

# ============================================================================
# IMPORT EXTERNAL AI ANALYSIS
# ============================================================================

if [ -n "$IMPORT_AI" ]; then
    if [ ! -f "$IMPORT_AI" ]; then
        echo -e "${RED}Error: AI analysis file not found: $IMPORT_AI${NC}"
        exit 1
    fi
    
    echo -e "${BOLD}${MAGENTA}ğŸŒ IMPORTING EXTERNAL AI ANALYSIS${NC}"
    echo ""
    
    AI_RESPONSE=$(cat "$IMPORT_AI")
    
    echo -e "${GREEN}âœ“ External AI analysis loaded successfully${NC}"
    echo ""
    
    # Display with critical vulnerability highlighting
    if echo "$AI_RESPONSE" | grep -qi "critical"; then
        echo ""
        echo -e "${BOLD}${RED}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "    âš ï¸  âš ï¸  âš ï¸   CRITICAL VULNERABILITIES DETECTED   âš ï¸  âš ï¸  âš ï¸"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo -e "${NC}"
        echo ""
    fi
    
    echo "$AI_RESPONSE"
    echo ""
    
    ALL_RESULTS+="\n=== EXTERNAL AI SECURITY ANALYSIS ===\n$AI_RESPONSE\n\n"
    
    NO_AI=true  # Skip local AI since we imported external
fi

# ============================================================================
# LOCAL AI ANALYSIS PHASE
# ============================================================================

if [ "$NO_AI" = false ]; then
    echo -e "${BOLD}${RED}ğŸ¤– PHASE 4: LOCAL AI SECURITY ANALYSIS${NC}"
    echo ""
    
    echo -e "${CYAN}ğŸ§  Checking local AI model: ${LOCAL_AI_MODEL}${NC}"
    if ! ollama list | grep -q "$LOCAL_AI_MODEL"; then
        echo -e "${YELLOW}âš ï¸  Model not found locally. Pulling ${LOCAL_AI_MODEL}...${NC}"
        ollama pull "$LOCAL_AI_MODEL"
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Failed to pull model${NC}"
            echo -e "${YELLOW}Available models: $(ollama list | tail -n +2 | awk '{print $1}')${NC}"
            echo -e "${CYAN}ğŸ’¡ Run with --no-ai to skip AI analysis${NC}"
            NO_AI=true
        fi
    fi
    
    if [ "$NO_AI" = false ]; then
        echo -e "${GREEN}âœ“ Model ready${NC}"
        echo ""
        
        read -r -d '' AI_PROMPT << 'EOFPROMPT'
You are an expert penetration tester analyzing scan results for a defense sector client. Provide a DETAILED security assessment.

## ğŸ¯ EXECUTIVE SUMMARY
- Overall risk level (CRITICAL/HIGH/MEDIUM/LOW)
- Total vulnerabilities found
- Most urgent issues
- Attack surface assessment

## ğŸš¨ CRITICAL FINDINGS (CVSS â‰¥9.0)
For each CRITICAL vulnerability:
- CVE ID and CVSS score
- Technical explanation (detailed)
- Real-world exploitation steps
- Proof-of-concept commands/payloads
- Business impact
- Immediate remediation (exact steps)

## âš ï¸ HIGH PRIORITY (CVSS 7.0-8.9)
For each HIGH severity issue:
- Vulnerability details
- Exploitation difficulty
- Attack vectors
- Recommended fixes with commands

## ğŸ”¸ MEDIUM PRIORITY (CVSS 4.0-6.9)
- Issue descriptions
- Impact assessment
- Remediation steps

## ğŸ” SECURITY CONFIGURATION
- Missing security headers (list each)
- SSL/TLS issues
- Service misconfigurations
- Best practice violations

## ğŸ› ï¸ REMEDIATION ROADMAP

### IMMEDIATE (24 hours):
1. [Specific action with exact commands]
2. [Next action with exact commands]

### SHORT-TERM (1 week):
1. [Specific action]
2. [Next action]

### LONG-TERM (1 month):
1. [Strategic improvements]

## ğŸ“Š TECHNICAL DETAILS
- Detected services and versions
- Version-specific vulnerabilities
- Potential attack chains
- Defense evasion techniques

Be thorough, technical, and actionable. Include specific commands and payloads.

---
SCAN RESULTS:
EOFPROMPT

        FULL_PROMPT="${AI_PROMPT}

Target: ${TARGET}
Scan Duration: ${MINUTES}m ${SECONDS}s
Scan Type: $([ "$QUICK_SCAN" = true ] && echo "Quick" || ([ "$FULL_SCAN" = true ] && echo "Full Aggressive" || echo "Standard"))

${ALL_RESULTS}
"
        
        echo -e "$FULL_PROMPT" > "$TEMP_DIR/ai_prompt.txt"
        
        echo -e "${CYAN}ğŸ§  Analyzing with local AI (this may take 2-5 minutes)...${NC}"
        echo -e "${YELLOW}â³ Processing ${#ALL_RESULTS} bytes of scan data${NC}"
        echo ""
        
        AI_RESPONSE=$(timeout 600 ollama run "$LOCAL_AI_MODEL" "$FULL_PROMPT" 2>&1)
        AI_EXIT_CODE=$?
        
        if [ $AI_EXIT_CODE -eq 0 ]; then
            echo -e "${GREEN}âœ“ AI Analysis Complete!${NC}"
            echo ""
            
            if echo "$AI_RESPONSE" | grep -qi "critical"; then
                echo ""
                echo -e "${BOLD}${RED}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "    âš ï¸  âš ï¸  âš ï¸   CRITICAL VULNERABILITIES DETECTED   âš ï¸  âš ï¸  âš ï¸"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo -e "${NC}"
                echo ""
            fi
            
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "$AI_RESPONSE"
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            
            ALL_RESULTS+="\n=== LOCAL AI SECURITY ANALYSIS ===\n$AI_RESPONSE\n\n"
        else
            echo -e "${RED}âŒ AI Analysis Failed or Timeout${NC}"
            echo -e "${YELLOW}ğŸ’¡ Export results for external AI: $0 $TARGET --export-for-ai${NC}"
            echo ""
        fi
    fi
fi

# ============================================================================
# REPORT GENERATION
# ============================================================================

REPORT_FILE="$HOME/aiscan_private_${TARGET}_$(date +%Y%m%d_%H%M%S).txt"

CRITICAL_VULNS=$(echo -e "$ALL_RESULTS" | grep -i "critical" | wc -l)
HIGH_VULNS=$(echo -e "$ALL_RESULTS" | grep -i "high" | wc -l)

cat > "$REPORT_FILE" << EOFREPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ğŸ”’ CONFIDENTIAL SECURITY ASSESSMENT REPORT ğŸ”’
                    AIScan Private Edition v2.1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸  CONFIDENTIAL - FOR AUTHORIZED PERSONNEL ONLY âš ï¸

Target:          $TARGET
Assessment Date: $(date)
Scan Duration:   ${MINUTES}m ${SECONDS}s
AI Model:        $([ "$NO_AI" = true ] && echo "None (AI-less mode)" || echo "$LOCAL_AI_MODEL (Local Processing)")
Privacy Mode:    ENABLED (All data processed locally)
CVE Database:    $([ "$SKIP_VULNINTEL" = true ] && echo "Disabled" || echo "NVD.gov")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    VULNERABILITY SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Potential CRITICAL findings: $CRITICAL_VULNS
Potential HIGH findings:     $HIGH_VULNS

$(if [ $CRITICAL_VULNS -gt 0 ]; then
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "    âš ï¸  âš ï¸  âš ï¸   CRITICAL VULNERABILITIES DETECTED   âš ï¸  âš ï¸  âš ï¸"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "IMMEDIATE ACTION REQUIRED - Review CRITICAL findings below"
echo ""
fi)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ASSESSMENT FINDINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$(echo -e "$ALL_RESULTS")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   SECURITY RECOMMENDATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This assessment was conducted using:
- Port scanning and service enumeration (Nmap)
- Web technology fingerprinting (WhatWeb)
- Vulnerability database correlation (NVD)
- Web vulnerability scanning (Nikto)
- Template-based CVE scanning (Nuclei)
- SQL injection testing (SQLMap)
- SSL/TLS security analysis (TestSSL/OpenSSL)
- WAF/CDN detection (Wafw00f)
- DNS enumeration
- HTTP security header analysis
$([ "$NO_AI" = false ] && echo "- Local AI security analysis (Ollama)")

IMPORTANT NOTES:
âœ… All client data remained on local infrastructure
âœ… No sensitive information transmitted to external AI services
âœ… CVE lookups performed against public NVD database only
âœ… Full scan logs available in: $TEMP_DIR/

NEXT STEPS:
1. Review all CRITICAL findings immediately (within 24 hours)
2. Implement immediate remediation actions
3. Schedule follow-up scan to verify fixes
4. Document all changes in change management system
5. Update security baseline documentation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        END OF REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Report ID: aiscan_$(date +%Y%m%d_%H%M%S)
Classification: CONFIDENTIAL
Distribution: Authorized Security Personnel Only

This report contains sensitive security information about ${TARGET}.
Unauthorized disclosure may result in exploitation of vulnerabilities.
Handle according to your organization's data classification policy.

EOFREPORT

echo -e "${GREEN}âœ… Confidential report saved to: ${REPORT_FILE}${NC}"
echo ""

if [ $CRITICAL_VULNS -gt 0 ]; then
    echo ""
    echo -e "${BOLD}${RED}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "                  âš ï¸  CRITICAL VULNERABILITIES  âš ï¸"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${YELLOW}$CRITICAL_VULNS potential CRITICAL vulnerabilities detected!${NC}"
    echo -e "${YELLOW}$HIGH_VULNS potential HIGH severity issues detected!${NC}"
    echo ""
    echo -e "${RED}IMMEDIATE ACTION REQUIRED - Review report immediately${NC}"
    echo ""
fi

echo -e "${BOLD}${CYAN}ğŸ“Š SCAN SUMMARY${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}Target:${NC}          $TARGET"
echo -e "${CYAN}Duration:${NC}        ${MINUTES}m ${SECONDS}s"
echo -e "${CYAN}Tools Used:${NC}      $(echo -e "$ALL_RESULTS" | grep -c "===" ) scan types"
echo -e "${CYAN}Report:${NC}          $REPORT_FILE"
echo -e "${CYAN}Privacy:${NC}         ${GREEN}âœ“ All data processed locally${NC}"
echo -e "${CYAN}Critical:${NC}        ${RED}$CRITICAL_VULNS potential findings${NC}"
echo -e "${CYAN}High:${NC}            ${YELLOW}$HIGH_VULNS potential findings${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

chmod 600 "$REPORT_FILE"
echo -e "${CYAN}ğŸ”’ Report permissions set to 600 (owner read/write only)${NC}"
echo ""

echo -e "${BOLD}${RED}âš ï¸  SECURITY REMINDERS:${NC}"
echo -e "${YELLOW}   â€¢ This scan was authorized for: $TARGET${NC}"
echo -e "${YELLOW}   â€¢ Report contains confidential client data${NC}"
echo -e "${YELLOW}   â€¢ Store report securely and encrypt if transmitting${NC}"
echo -e "${YELLOW}   â€¢ Follow responsible disclosure for any findings${NC}"
echo -e "${YELLOW}   â€¢ Prioritize CRITICAL vulnerabilities for immediate action${NC}"
echo ""

if [ "$NO_AI" = true ] && [ "$EXPORT_FOR_AI" = false ]; then
    echo -e "${CYAN}ğŸ’¡ TIP: Export for external AI analysis:${NC}"
    echo -e "   $0 $TARGET --export-for-ai"
    echo ""
fi

echo -e "${GREEN}âœ“ Scan completed successfully! (Private Edition v2.1)${NC}"
echo ""

if [ $CRITICAL_VULNS -gt 0 ] || [ $HIGH_VULNS -gt 5 ]; then
    echo -e "${YELLOW}âš ï¸  Report contains sensitive findings${NC}"
    read -p "$(echo -e ${CYAN}Encrypt report with GPG? [y/N]: ${NC})" -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if command -v gpg &> /dev/null; then
            gpg -c "$REPORT_FILE"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}âœ“ Report encrypted: ${REPORT_FILE}.gpg${NC}"
                read -p "$(echo -e ${YELLOW}Delete unencrypted report? [y/N]: ${NC})" -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    shred -u "$REPORT_FILE"
                    echo -e "${GREEN}âœ“ Unencrypted report securely deleted${NC}"
                fi
            fi
        else
            echo -e "${YELLOW}GPG not installed. Install with: sudo apt install gnupg${NC}"
        fi
    fi
fi

echo ""
